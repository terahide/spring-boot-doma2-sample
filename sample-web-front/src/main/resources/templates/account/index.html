<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}" th:with="menu='account'"><!--/* menuItemにパラメータを渡す */-->
<head layout:fragment="~{common/layout::header}">
    <title>アカウント</title>
</head>
<body>
<!--/* この形式のコメントはHTMLソースから削除される */-->
<div layout:fragment="content">
    <h2>アカウント</h2>
    <div><span class="glyphicon glyphicon-envelope">email：</span><span th:text="${user.email}" /></div>
    <div><image th:unless="${user.hasImage()}" height="200px" th:src="@{/static/images/no_photo.png}" /><image th:if="${user.hasImage()}" height="200px" th:src="@{/user/__${user.id}__/image}" /></div>
    <div><span class="glyphicon glyphicon-user">名前：</span><span th:text="${user.name}" /></div>
    <div><span class="glyphicon glyphicon-phone">電話：</span><span th:text="${user.tel}" /></div>
    <div><span class="glyphicon glyphicon-tag">所属：</span><span th:text="${user.dept}" /></div>
    <div><span class="glyphicon glyphicon-info-sign">紹介：</span><span th:if="${user.info == null}" >（紹介はまだ記載されていません）</span><span th:if="${user.info != null}" th:text="${user.info}" /></div>
    <br />
    <div>
        <span th:unless="${isMyAccount}"><a th:href="@{/arigato?name=__${user.name}__}" id="toArigato" class="glyphicon glyphicon-heart">ありがとする</a></span>
        <span th:if="${isMyAccount}">
            <a th:href="@{/account/profile}" id="toProfile" class="glyphicon glyphicon-pencil">プロフィール編集</a>
            <a th:href="@{/account/password}" id="toPassword" class="glyphicon glyphicon-info-sign">パスワード変更</a>
        </span>
    </div>
    <hr />
    <div><a href="javascript:void(0)" id="fromMeToggle" class="glyphicon glyphicon-comment"><span th:text="${user.name}" /> さんへのありがとへ</a> <a href="javascript:void(0)" id="toMeToggle" class="glyphicon glyphicon-folder-open"><span th:text="${user.name}" /> さんからのありがとへ</a></div>
    <div id="fromMe">
        <div class="agigatoContainer">
        <section class="arigato unsetup" th:each="arigato : ${page_from.data}" th:object="${arigato}">
            <hr />
            <dev th:replace="~{arigato/item :: item (${arigato})}" />
        </section>
        </div>
        <div th:if="${page_from.hasMorePage()}"><hr /><a th:data-url="${moreUrl}" href="javascript:void(0)" id="moreFromMe">もっと見る</a></div>
    </div>
    <div id="toMe">
        <div class="agigatoContainer">
        <section class="arigato unsetup" th:each="arigato : ${page_to.data}" th:object="${arigato}">
            <hr />
            <dev th:replace="~{arigato/item :: item (${arigato})}" />
        </section>
        </div>
        <div th:if="${page_to.hasMorePage()}"><hr /><a th:data-url="${moreUrl}" href="javascript:void(0)" id="moreToMe">もっと見る</a></div>
    </div>
</div>
<div layout:fragment="scripts" th:remove="tag">
    <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}" />
    <input
            type="hidden"
            id="fromMeP"
            th:value="${page_from.page}" />
    <input
            type="hidden"
            id="toMeP"
            th:value="${page_to.page}" />
    <script type="text/javascript" th:src="@{/static/js/arigato/eventHandlerSetup.js}"></script>
    <script type="text/javascript">
        $.ajaxSetup({
            headers: { 'X-XSRF-TOKEN': $('input[name="_csrf"]').val() }
        });
        const handleMore = (event, type, $container, $p) => {
            const $this = $(event.currentTarget);
            const p = parseInt($p.val()) + 1;
            $.ajax({
                url: $this.data('url') + type + "/" + p,
                type: 'GET'
            }).done( (data) => {
                if(data.includes('section')){
                    $p.val(p);
                    $container.append(data)
                    setupHandler();
                }else{
                    $this.hide();
                }
            }).fail( (data) => {
                alert('error'); //TODO Fake It
            })
        };
        $().ready(() => {
            setupHandler();
            $('#toMeToggle, #toMe').hide();
            $('#fromMeToggle, #toMeToggle').on('click', event => {
                var $this = $(event.currentTarget)
                console.log(0)
                $('#fromMeToggle, #toMeToggle, #fromMe, #toMe').toggle()
            })

            $('#moreFromMe').on('click', event => {
                handleMore(event,
                            '/from/me',
                            $('#fromMe .agigatoContainer'),
                            $('#fromMeP'));
            });
            $('#moreToMe').on('click', event => {
                handleMore(event,
                            '/to/me',
                            $('#toMe .agigatoContainer'),
                            $('#toMeP'));
            });
        });
    </script>
</div>>
</body>
</html>
